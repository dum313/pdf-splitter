# üì¶ –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import os                   # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –ø—É—Ç—è–º–∏
import re                   # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º–∏ (–ø–æ–∏—Å–∫ ID)
import pytesseract          # –î–ª—è OCR ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö
from pdf2image import convert_from_path  # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è PDF –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
from PyPDF2 import PdfReader, PdfWriter  # –î–ª—è —á—Ç–µ–Ω–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏—è PDF
from tkinter import Tk, filedialog       # –î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞

# üîπ –û—Ç–∫–ª—é—á–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ tkinter (–æ–Ω–æ –Ω–µ –Ω—É–∂–Ω–æ)
Tk().withdraw()

# üîπ –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ PDF-—Ñ–∞–π–ª–∞
source_pdf = filedialog.askopenfilename(
    title="–í—ã–±–µ—Ä–∏—Ç–µ PDF-—Ñ–∞–π–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏",
    filetypes=[("PDF —Ñ–∞–π–ª—ã", "*.pdf")]
)

# ‚ùå –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–ª ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
if not source_pdf:
    print("–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ.")
    exit()

# üîπ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è –ø–∞–ø–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ–Ω–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ PDF-—Ñ–∞–π–ª–∞
# –ü—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è fail1.pdf ‚Üí –ø–∞–ø–∫–∞ –±—É–¥–µ—Ç "fail1"
pdf_name = os.path.splitext(os.path.basename(source_pdf))[0]
output_folder = pdf_name
os.makedirs(output_folder, exist_ok=True)

# üîπ –ó–∞–≥—Ä—É–∂–∞–µ–º PDF-—Ñ–∞–π–ª
reader = PdfReader(source_pdf)

# üîπ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É PDF –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (300 dpi ‚Äî —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è OCR)
images = convert_from_path(source_pdf, dpi=300)

# üîπ –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ ID –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
# 4 –±—É–∫–≤—ã ‚Üí –æ–ø—Ü. 1 –±—É–∫–≤–∞ ‚Üí 7 —Ü–∏—Ñ—Ä ‚Üí –±—É–∫–≤–∞ P (–ø—Ä–∏–º–µ—Ä: CICU6332694P)
flex_pattern = re.compile(r"([A-Z]{4})([A-Z]?)(\d{7})([P])")

# üîπ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±–ª–∞—Å—Ç–∏, –≥–¥–µ –æ–±—ã—á–Ω–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω ID –Ω–∞ —Å–∫–∞–Ω–∞—Ö
# (–ª–µ–≤—ã–π –∫—Ä–∞–π, –≤–µ—Ä—Ö–Ω–∏–π –∫—Ä–∞–π, –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π, –Ω–∏–∂–Ω–∏–π –∫—Ä–∞–π)
crop_area = (0, 1900, 1000, 2300)

# üîπ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–æ—á–µ—Ä—ë–¥–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã
i = 0
while i < len(reader.pages):
    # --- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É ---
    image = images[i]
    cropped_image = image.crop(crop_area)  # –í—ã—Ä–µ–∑–∞–µ–º –Ω—É–∂–Ω—É—é –æ–±–ª–∞—Å—Ç—å
    text = pytesseract.image_to_string(cropped_image)  # –†–∞—Å–ø–æ–∑–Ω–∞—ë–º —Ç–µ–∫—Å—Ç
    text_clean = re.sub(r"[\s()\-\n]+", "", text.upper())  # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã

    # üîç –ò—â–µ–º ID –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    match = flex_pattern.search(text_clean)
    if match:
        part1, extra_letter, part2, last_letter = match.groups()
        identifier = part1 + part2  # –ù–∞–ø—Ä–∏–º–µ—Ä: CICU6332694
    else:
        identifier = f"unknown_{i+1}"  # –ï—Å–ª–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω
        print(f"–°—Ç—Ä.{i+1}: ID –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí '{text_clean}'")

    # --- –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π PDF-—Ñ–∞–π–ª –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç—É–¥–∞ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É ---
    writer = PdfWriter()
    writer.add_page(reader.pages[i])

    # --- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É ---
    if i + 1 < len(reader.pages):
        next_image = images[i+1].crop(crop_area)
        next_text = pytesseract.image_to_string(next_image)
        next_clean = re.sub(r"[\s()\-\n]+", "", next_text.upper())

        # –ï—Å–ª–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ù–ï–¢ ID ‚Äî –æ–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è
        if not flex_pattern.search(next_clean):
            writer.add_page(reader.pages[i+1])  # –î–æ–±–∞–≤–ª—è–µ–º –µ—ë —Ç–æ–∂–µ
            i += 2  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º —Å—Ä–∞–∑—É —á–µ—Ä–µ–∑ 2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        else:
            i += 1  # –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Äî —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è
    else:
        # –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Äî –æ–¥–∏–Ω–æ—á–Ω–∞—è
        i += 1

    # --- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–∞–π–ª ---
    output_path = os.path.join(output_folder, f"{identifier}.pdf")
    with open(output_path, "wb") as out_pdf:
        writer.write(out_pdf)

    print(f"‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: {output_path}")
